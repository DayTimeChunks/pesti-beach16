---
title: "Observed Data Prep for Model Analysis"
author: "PAZ"
date: "31/01/2018"
output: pdf_document
---

```{r, echo=FALSE, message=FALSE, include=FALSE}
Sys.setlocale("LC_ALL", "English")

MAC = T
WIN = F
```

# Purpose

Generate BEACH calibration data with:

- **groupAlteck2016_R.csv** (Book 04)

# Lab parameters and field constants

```{r}
if (MAC) {
  if (WIN){
    path = file.path("C:/Users/DayTimeChunks/Documents/PhD/HydrologicalMonitoring")
    
  } else {
    # path = file.path("/Users/DayTightChunks/Documents/PhD/HydrologicalMonitoring")
    path = file.path("/Users/DayTightChunks/Documents/PhD/HydroMonitor/.nosync/HydrologicalMonitoring")
  }
} else {
  path = file.path("D:/Documents/these_pablo/Alteckendorf2016/HydrologicalMonitoring")
  time = read.csv2("D:/Documents/these_pablo/Models/BEACH2016/Analysis/Data/Time.csv")
  time$DayMoYr = as.POSIXct(strptime(time$Date, "%d/%m/%Y", tz="EST"))
}
source(file.path(path, "global.R"))
```


# Packages

```{r, message=FALSE}

# Plotting functions
library("scales")
library("tidyr")
library("dplyr")
library("reshape")
library("zoo") # na.approx()

```

## Working directory

```{r, message=FALSE}

# setwd("D:/Documents/these_pablo/Alteckendorf2016/R")

# MAC
# setwd("/Users/DayTightChunks/Documents/PhD/Routput/Alteck/R")

# Mac-WIN
# setwd("C:/Users/DayTightChunks/Documents/Models/pesti-beach16/Analysis/Data")
getwd()

```


# Discharge & Response Variables (with markers)

- Ignoring $\delta$ in filters (for now)

```{r}
q = read.csv2(file.path(path, "Data/groupAlteck2016_R.csv"))
q$Vol.L = q$Vol2min * 1000

q = q[ , c("Date", "DateCheck", "Q.HW1", "DayMoYr", "Vol.L", "sampleQ", "Type", "SubWeeks", "Weeks", "WeekNo" )]
names(q)

mark = read.csv(file.path(path, "Data/MarkerResponse_R05.csv"))
mark = mark[, c("WeekSubWeek", 
                # "AveDischarge.m3.h", "Volume.m3",  "Sampled.Hrs", 
                # "Sampled", 
                "Conc.mug.L" , "Conc.SD",
                # "Vol.SPE.L", "Conc.in500uL", 
                "OXA_mean", "OXA_SD", "ESA_mean", "ESA_SD", 
                "N.x", "diss.d13C", "SD.d13C",
                "MES.mg.L", "MES.sd", "MO.mg.L", "Conc.Solids.mug.gMES", "Conc.Solids.ug.gMES.SD" #, 
                #"N.y",  "filt.d13C",  "filt.SD.d13C" #, 
                #"DD13C.diss", "DD13C.filt" 
                )] 
names(mark)
# Delete repeated W6 observation, or with NA in week markers
# mark = mark[mark$WeekSubWeek != as.character("W6-3j7") & !is.na(mark$WeekSubWeek), ]



q$Date = as.POSIXct(strptime(q$DateCheck, "%d/%m/%Y %H:%M", tz="EST"))
q$DayMoYr = as.POSIXct(strptime(q$DateCheck, "%d/%m/%Y", tz="EST"))

CHECKO = F
if (CHECKO){
  sum(is.na(q$Date))
  naDates = q[is.na(q$Date == TRUE),]

  duplicateAlteck <- q[duplicated(q$DateCheck),]
  head(duplicateAlteck)
}



```

## Merge 2-min disch with sub-weekly markers

- Convert to mass (and corresponding SD) discharged 


```{r}
qm = merge(q, mark, by.x = "SubWeeks", by.y = "WeekSubWeek", all = T)


# Dissolved
qm$SmetOut_ug.obs = qm$Vol.L*qm$Conc.mug.L
qm$SmetOut_ug.sd = qm$Vol.L*qm$Conc.SD
qm$OxaOut_ug.obs =  qm$Vol.L*qm$OXA_mean
qm$OxaOut_ug.sd =  qm$Vol.L*qm$OXA_SD
qm$EsaOut_ug.obs =  qm$Vol.L*qm$ESA_mean
qm$EsaOut_ug.sd =  qm$Vol.L*qm$ESA_SD

# Suspended Solids (SS)
# Smet.ug in SS = ug/g * (MES [mg/L] * [1g/10^3mg])  * Vol [L]
qm$SmetSS_ug.obs = qm$Conc.Solids.mug.gMES * (qm$MES.mg.L*1/10^3)  * qm$Vol.L 
qm$SmetSS_ug.sd = qm$Conc.Solids.ug.gMES.SD * (qm$MES.sd*1/10^3)  * qm$Vol.L 

qm$MassDelta.obs = qm$SmetOut_ug.obs*qm$diss.d13C
qm$MassDelta.sd = qm$SmetOut_ug.sd*qm$SD.d13C


names(qm)
```

## Compute by-day & by-subweek 

- ignoring solids (for now)

We need to obtain a bulk concentration for the day, not by taking the mean concentration, but rather the proportional mass contribution of each sub-sample, determined by the relative volume  such that the concentration of each daily sample $(C_i)$ is :

\begin{equation}
C_{bulk sample} = \frac{C_1 \cdot V_1 + C_2 \cdot V_2}{V_{tot}}
\label{eq:conc_bulk}
\end{equation}

To obtain the bluk concentration (and because there are overlapps of some days across subsamples) we need to first to:

1. Convert discharge mass to concentration
2. Interpolate concentrations (and deltas) of only the duplicate days, where no sample was possible


```{r}

# Step 1
qmDay <- qm %>%
  group_by(DayMoYr, SubWeeks) %>%
  dplyr::summarize(Volday.L = sum(Vol.L),
                   SmOut_ug.obs = sum(SmetOut_ug.obs),
                   SmOut_ug.sd = (sum(SmetOut_ug.sd^2))^0.5, # Cumulative SD
                   OxOut_ug.obs = sum(OxaOut_ug.obs),
                   OxOut_ug.sd = (sum(OxaOut_ug.sd^2))^0.5, # Cumulative SD
                   EsOut_ug.obs = sum(EsaOut_ug.obs),
                   EsOut_ug.sd = (sum(EsaOut_ug.sd^2))^0.5, # Cumulative SD
                   ConcSmOut_ugL.obs = SmOut_ug.obs/Volday.L, # Smet
                   ConcSmOut_ugL.sd = SmOut_ug.sd/Volday.L,
                   ConcOxOut_ugL.obs = OxOut_ug.obs/Volday.L, # Oxa
                   ConcOxOut_ugL.sd = OxOut_ug.sd/Volday.L,
                   ConcEsOut_ugL.obs = EsOut_ug.obs/Volday.L, # Esa
                   ConcEsOut_ugL.sd = EsOut_ug.sd/Volday.L,
                   delta.obs = sum(MassDelta.obs)/(sum(SmetOut_ug.obs)),
                   delta.sd = (sum(MassDelta.sd^2))^0.5/(sum(SmetOut_ug.sd^2))^0.5
                   )


# Step 2

# Get all duplicated days
allDup = qmDay %>%
  group_by(DayMoYr) %>% 
  filter(n()>1)

# Assume same delta on the same day
deltasDup = allDup %>%
  group_by(DayMoYr) %>% 
  dplyr::summarize(delta.obs = mean(delta.obs, na.rm = T),
                   delta.sd = mean(delta.sd, na.rm = T))

deltasDup$delta.obs = ifelse(deltasDup$delta.obs == "NaN", NA, deltasDup$delta.obs)
deltasDup$delta.sd = ifelse(deltasDup$delta.sd == "NaN", NA, deltasDup$delta.sd)

# Delete delta columns on allDup
cols = ncol(allDup)-2
allDup = allDup[, c(1:cols)]

# Invert 1st two rows for na.approx
allDup = allDup[c(2,1:nrow(allDup)), ]

allDup$ConcSmOut_ugL.obs = na.approx(allDup$ConcSmOut_ugL.obs)
allDup$ConcSmOut_ugL.sd = na.approx(allDup$ConcSmOut_ugL.sd)

allDup$ConcOxOut_ugL.obs= na.approx(allDup$ConcOxOut_ugL.obs)
allDup$ConcOxOut_ugL.sd = na.approx(allDup$ConcOxOut_ugL.sd)

allDup$ConcEsOut_ugL.obs = na.approx(allDup$ConcEsOut_ugL.obs)
allDup$ConcEsOut_ugL.sd = na.approx(allDup$ConcEsOut_ugL.sd)

allDup = merge(allDup, deltasDup, by = "DayMoYr", all = T)

ndup = qmDay %>%
  group_by(DayMoYr) %>% 
  filter(n()==1)


qmDay = rbind.data.frame(ndup, allDup)

qmDay = qmDay[order(qmDay$DayMoYr), ]

# head(dupQm)
```

3. Apply eq. \ref{eq:conc_bulk} while grouping by day

```{r}

qmBlk = qmDay %>%
  group_by(DayMoYr) %>%
  dplyr::summarize(VolTot.L = sum(Volday.L),
                   ConSmOut_ugL.blk = sum(ConcSmOut_ugL.obs * Volday.L)/sum(Volday.L),
                   ConSmOut_ugL.sd = sum(ConcSmOut_ugL.sd * Volday.L)/sum(Volday.L),
                   ConOxOut_ugL.blk = sum(ConcOxOut_ugL.obs * Volday.L)/sum(Volday.L),
                   ConOxOut_ugL.sd = sum(ConcOxOut_ugL.sd * Volday.L)/sum(Volday.L),
                   ConEsOut_ugL.blk = sum(ConcEsOut_ugL.obs * Volday.L)/sum(Volday.L),
                   ConEsOut_ugL.sd = sum(ConcEsOut_ugL.sd * Volday.L)/sum(Volday.L),
                   deltaOut.blk = sum(delta.obs * Volday.L)/sum(Volday.L),         
                   deltaOut.sd =  sum(delta.sd * Volday.L)/sum(Volday.L) 
                   )

```

4. Merge markers

```{r}
m <- q %>%
  group_by(DayMoYr) %>%
  dplyr::summarise(SubWeeks = SubWeeks[1])
  
qmBlk = merge(qmBlk, m, by = "DayMoYr")

qmBlk = merge(time, qmBlk, by = "DayMoYr", all = T)
# qmBlk$JDay = seq.int(nrow(qmBlk)) + 176

write.csv(qmBlk, "qmBlk_R.csv", row.names = F) # , sep = ";", dec = ".")
```


## Prepare Volume Discharged Time Series (TSS)

```{r}

names(qmBlk)
# Vol.L/day
# qmBlk$time = seq.int(nrow(qmBlk)) 

qmBlk$VolTot.m3 = round(qmBlk$VolTot.L/10^3, 3)

mean(qmBlk$VolTot.m3, na.rm = T)
sd(qmBlk$VolTot.m3, na.rm = T)
Volm3_tss = qmBlk[,c("Jdays", "VolTot.m3")] 

Volm3_tss$VolTot.m3 = ifelse(is.na(Volm3_tss$VolTot.m3), -1.0, Volm3_tss$VolTot.m3)


write.table(Volm3_tss, "BEACH_R/q_obs_m3day.tss", sep="\t", row.names = F, col.names = F)




if (F) {
  
  ## Convert m3.h -> m3
  qDay <- q %>%
    group_by(DayMoYr) %>%
    dplyr::summarize(Q.m3 = sum(Vol2min))
  
  qDay$Q.mm = (qDay$Q.m3/catchment_area)*10^3
  
  qDay$time = seq.int(nrow(qDay)) 

  # Qm3/day
  DischQm3_tss = qDay[,c("time", "Q.m3")] 
  write.table(DischQm3_tss, "BEACH_R/disch_m3day.tss", sep="\t", row.names = F)
  
  # Qmm/day
  DischQmm_tss = qDay[,c("time", "Q.mm")] 
  write.table(DischQmm_tss, "BEACH_R/disch_mmday.tss", sep="\t", row.names = F)
 
  
}
```


## Analyse Discharge Monthly Values


```{r}

if (F) {
  qDay$Month <- 
  ifelse(qDay$DayMoYr >= as.POSIXct("2016-03-24 00:30:00", tz = "EST") &
           qDay$DayMoYr < as.POSIXct("2016-04-01 00:00:00", tz = "EST"), "March",
         ifelse(qDay$DayMoYr >= as.POSIXct("2016-04-01 00:00:00", tz = "EST") &
                  qDay$DayMoYr < as.POSIXct("2016-05-01 00:00:00", tz = "EST"), "April",
                ifelse(qDay$DayMoYr >= as.POSIXct("2016-05-01 00:00:00", tz = "EST") &
                         qDay$DayMoYr < as.POSIXct("2016-06-01 00:00:00", tz = "EST"), "May",
                       ifelse(qDay$DayMoYr >= as.POSIXct("2016-06-01 00:00:00", tz = "EST") & 
                                qDay$DayMoYr < as.POSIXct("2016-07-01 00:00:00", tz = "EST"), "June", "July" )
                            )
                     )
         )

dischSumm <- qDay %>%
  group_by(Month) %>%
  dplyr::summarize(MeanQmm = mean(Q.mm),
                   SdevQmm = sd(Q.mm),
                   MeanQm3 = mean(Q.m3))
  
}


```

