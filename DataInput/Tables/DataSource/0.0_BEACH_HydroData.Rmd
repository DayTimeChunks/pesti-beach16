---
title: "BEACH Hydro Data Preparation"
author: "PAZ"
date: "31/01/2018"
output: pdf_document
---

```{r, echo=FALSE, message=FALSE, include=FALSE}
Sys.setlocale("LC_ALL", "English")

MAC = TRUE
```

# Purpose

Generate BEACH calibration data with:

- **groupAlteck2016_R.csv** (Book 04)

# Lab parameters and field constants

```{r}
if (MAC) {
  path = file.path("/Users/DayTightChunks/Documents/PhD/HydrologicalMonitoring")
} else {
  path = file.path("D:/Documents/these_pablo/Alteckendorf2016/HydrologicalMonitoring")
}
source(file.path(path, "global.R"))
```


# Packages

```{r, message=FALSE}

# Plotting functions
library("scales")
library("tidyr")
library("dplyr")
library("reshape")

```

## Working directory

```{r, message=FALSE}

# setwd("D:/Documents/these_pablo/Alteckendorf2016/R")
# setwd("/Users/DayTightChunks/Documents/PhD/Routput/Alteck/R")
getwd()

```

# Rainfall

**Note: Not for TSS**
This was not the source for BEACH input, this was only to analyse Alteck's Pluviometer, which has only rainfall from March 2016 onward.

```{r}
rain = read.csv2(file.path(path, "Data/sixMinutePluvioAlteck2016.csv"), header = F)

head(rain)

rain$V1 <- as.character(rain$V1)
rain$Date = as.POSIXct(strptime(rain$V1,
                                "%d/%m/%Y %H:%M", tz="EST") )

rain$DayMoYr = as.POSIXct(strptime(rain$V1,
                                   "%d/%m/%Y", tz="EST")  ) 

# Check number of NA values
CHECKO = FALSE
if (CHECKO){
  sum(is.na(rain$Date))
  naDates = rain[is.na(rain$Date == TRUE),]  
}

rainDay <- rain %>%
  group_by(DayMoYr) %>%
  dplyr::summarize(Rain.mm = sum(V2))
```

## Prepare Rainfall Time Series (TSS)

```{r}
if (FALSE) {
  rainDay$time = seq.int(nrow(rainDay)) 
  rain_tss = rainDay[,c("time", "Rain.mm")] 
  #rain_tss = rbind(c("2016-03-25 to 2016-07-11", NA), rain_tss)
  write.table(rain_tss, "BEACH_R/rain_mmday.tss", sep="\t", row.names = F)  
}

```

## Analyse Rainfall Monthly Values

```{r}
rainDay$Month <- 
  ifelse(rainDay$DayMoYr >= as.POSIXct("2016-03-24 00:30:00", tz = "EST") &
           rainDay$DayMoYr < as.POSIXct("2016-04-01 00:00:00", tz = "EST"), "March",
         ifelse(rainDay$DayMoYr >= as.POSIXct("2016-04-01 00:00:00", tz = "EST") &
                  rainDay$DayMoYr < as.POSIXct("2016-05-01 00:00:00", tz = "EST"), "April",
                ifelse(rainDay$DayMoYr >= as.POSIXct("2016-05-01 00:00:00", tz = "EST") &
                         rainDay$DayMoYr < as.POSIXct("2016-06-01 00:00:00", tz = "EST"), "May",
                       ifelse(rainDay$DayMoYr >= as.POSIXct("2016-06-01 00:00:00", tz = "EST") & 
                                rainDay$DayMoYr < as.POSIXct("2016-07-01 00:00:00", tz = "EST"), "June", "July" )
                            )
                     )
         )

rainDay$Wet = ifelse(rainDay$Rain.mm > 0, 1, 0)
rainDay$Dry = ifelse(rainDay$Rain.mm == 0, 1, 0)

rainSumm <- rainDay %>%
  group_by(Month) %>%
  dplyr::summarize(WetDays = sum(Wet),
                   DryDays = sum(Dry),
                   MeanP = mean(Rain.mm),
                   StdP = sd(Rain.mm),
                   TotP = sum(Rain.mm))

rainSumm$Prct = rainSumm$WetDays/(rainSumm$WetDays+rainSumm$DryDays)
```

# Discharge & Response Variables (with markers)

```{r}
q = read.csv2(file.path(path, "Data/groupAlteck2016_R.csv"))
q = q[ , c("Date", "DateCheck", "Q.HW1", "DayMoYr", "Vol2min", "sampleQ", "Type", "SubWeeks", "Weeks", "WeekNo" )]
names(q)

mark = read.csv(file.path(path, "Data/MarkerResponse_R05.csv"))
mark = mark[, c("WeekSubWeek", 
                # "AveDischarge.m3.h", "Volume.m3",  "Sampled.Hrs", 
                # "Sampled", 
                "Conc.mug.L" , "Conc.SD",
                # "Vol.SPE.L", "Conc.in500uL", 
                "OXA_mean", "OXA_SD", "ESA_mean", "ESA_SD", 
                "N.x", "diss.d13C", "SD.d13C",
                "MES.mg.L", "MES.sd", "MO.mg.L", "Conc.Solids.mug.gMES", "Conc.Solids.ug.gMES.SD", 
                "N.y",  "filt.d13C",  "filt.SD.d13C" #, 
                #"DD13C.diss", "DD13C.filt" 
                )] 
names(mark)
# Delete repeated W6 observation, or with NA in week markers
mark = mark[mark$WeekSubWeek != as.character("W6-3j7") & !is.na(mark$WeekSubWeek), ]



q$Date = as.POSIXct(strptime(q$DateCheck, "%d/%m/%Y %H:%M", tz="EST"))
q$DayMoYr = as.POSIXct(strptime(q$DateCheck, "%d/%m/%Y", tz="EST"))

CHECKO = F
if (CHECKO){
  sum(is.na(q$Date))
  naDates = q[is.na(q$Date == TRUE),]

  duplicateAlteck <- q[duplicated(q$DateCheck),]
  head(duplicateAlteck)
}
## Convert m3.h -> m3


#qDay <- q %>%
#  group_by(DayMoYr) %>%
#  dplyr::summarize(Q.m3 = sum(Vol2min))

#qDay$Q.mm = (qDay$Q.m3/catchment_area)*10^3
```

## Prepare Discharge Time Series (TSS)

```{r}
if (F) {
  qDay$time = seq.int(nrow(qDay)) 

  # Qm3/day
  DischQm3_tss = qDay[,c("time", "Q.m3")] 
  write.table(DischQm3_tss, "BEACH_R/disch_m3day.tss", sep="\t", row.names = F)
  
  # Qmm/day
  DischQmm_tss = qDay[,c("time", "Q.mm")] 
  write.table(DischQmm_tss, "BEACH_R/disch_mmday.tss", sep="\t", row.names = F)
  
}
```


## Analyse Discharge Monthly Values


```{r}
qDay$Month <- 
  ifelse(qDay$DayMoYr >= as.POSIXct("2016-03-24 00:30:00", tz = "EST") &
           qDay$DayMoYr < as.POSIXct("2016-04-01 00:00:00", tz = "EST"), "March",
         ifelse(qDay$DayMoYr >= as.POSIXct("2016-04-01 00:00:00", tz = "EST") &
                  qDay$DayMoYr < as.POSIXct("2016-05-01 00:00:00", tz = "EST"), "April",
                ifelse(qDay$DayMoYr >= as.POSIXct("2016-05-01 00:00:00", tz = "EST") &
                         qDay$DayMoYr < as.POSIXct("2016-06-01 00:00:00", tz = "EST"), "May",
                       ifelse(qDay$DayMoYr >= as.POSIXct("2016-06-01 00:00:00", tz = "EST") & 
                                qDay$DayMoYr < as.POSIXct("2016-07-01 00:00:00", tz = "EST"), "June", "July" )
                            )
                     )
         )

dischSumm <- qDay %>%
  group_by(Month) %>%
  dplyr::summarize(MeanQmm = mean(Q.mm),
                   SdevQmm = sd(Q.mm),
                   MeanQm3 = mean(Q.m3))

```

# EvapoTranspiration (ETP)

Note, these calculations are done in the excel file for now: ZornDaily_Oct2015toJune2017.xls 

```{r}
etp = read.csv2(file.path(path, "Data/ZornDaily.csv"), sep = ",")
head(etp)

etp$DATE = as.character(etp$DATE) 
etp$DayMoYr = as.POSIXct(strptime(etp$DATE, "%m/%d/%y", tz="EST"))

```
